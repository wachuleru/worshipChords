<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üé∂ Alabanzas ChordPro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    pre { 
      font-family: monospace; 
      line-height: 1.4; 
      margin-bottom: 0; 
      white-space: pre-wrap;
    }
    .chord-line { 
      color: #007bff; 
      font-weight: bold; 
    }
    .file-input { display: none; }
    #songList, #selectedList {
      height: 50vh;
      overflow-y: auto;
    }

    /* üåû Modo D√≠a */
    body.light-mode {
      background-color: #ffffff;
      color: #212529;
    }
    body.light-mode .list-group-item {
      background-color: #fff;
      color: #212529;
    }
    body.light-mode .btn-outline-secondary {
      color: #212529;
      border-color: #adb5bd;
    }

    /* üåô Modo Noche */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode .list-group-item {
      background-color: #1e1e1e;
      color: #e0e0e0;
    }
    body.dark-mode .btn-outline-secondary {
      color: #e0e0e0;
      border-color: #666;
    }
    body.dark-mode .chord-line {
      color: #66b3ff;
    }
    body.dark-mode pre {
      color: #e0e0e0;
    }
    .light {
      color:black !important;
    }
    .dark {
      color:white !important;
    }
    /* contenedor del texto renderizado de la alabanza */
    .alabanza-texto {
      column-count: 1;               /* por defecto, una sola columna */
      column-gap: 2rem;              /* espacio entre columnas */
      max-height: 80vh;              /* evita que crezca demasiado */
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 1rem;
      line-height: 1.5;
      transition: column-count 0.3s ease;
    }

    /* cuando la alabanza es larga, aplica dos columnas */
    .alabanza-texto.dos-columnas {
      column-count: 2;
    }

    /* mejora visual de acordes */
    .chord-line {
      font-weight: bold;
      color: #1a5edb;
    }
    /* üîΩ Panel colapsable lateral */
    #panelSeleccionadas {
      position: relative;
      transition: all 0.3s ease;
    }

    #togglePanelTab {
      position: absolute;
      top: 50%;
      right: -15px;
      transform: translateY(-50%);
      background-color: #6c757d;
      color: white;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 0 6px 6px 0;
      font-size: 1.2rem;
      user-select: none;
      transition: all 0.3s ease;
    }
    #togglePanelTab:hover {
      background-color: #495057;
    }

    /* üîΩ Columna expandida cuando el panel est√° oculto */
    .expandido {
      width: 100% !important;
      flex: 0 0 100% !important;
      max-width: 100% !important;
    }

  </style>
</head>
<body>
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-center flex-grow-1">üé∏ Mis Alabanzas</h2>
    <button id="themeToggle" class="btn btn-sm btn-outline-secondary ms-3">üåô Noche</button>
  </div>

  <!-- Buscar + importar/exportar -->
  <div class="input-group mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Buscar alabanza...">
    <button class="btn btn-outline-secondary" onclick="exportarJSON()">‚¨áÔ∏è Exportar</button>
    <label class="btn btn-outline-secondary mb-0">
      ‚¨ÜÔ∏è Importar
      <input type="file" id="importFile" class="file-input" accept="application/json" onchange="importarJSON(event)">
    </label>
  </div>

  <div class="row">
    <!-- Todas -->
    <div class="col-md-12">
      
      <div class="accordion " id="accordionExample">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" id="buttonCollapse" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
              <h5>Todas las alabanzas</h5>
            </button>
          </h2>
          <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
            <div class="accordion-body" id="contentAcc">
              <ul id="songList" class="list-group mb-3"></ul>
            </div>
          </div>
        </div>
        
      </div>
      
      <button class="btn btn-primary w-100 mb-4" onclick="nuevaAlabanza()">‚ûï Nueva alabanza</button>
    </div>

    
  </div>

  <hr>
  <div class="row">
    <!-- Seleccionadas -->
    <div id="panelSeleccionadas" class="col-md-4 position-relative">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5>Seleccionadas</h5>
        <button class="btn btn-sm btn-outline-danger" onclick="limpiarSeleccionadas()">Quitar todas</button>
      </div>
      <ul id="selectedList" class="list-group"></ul>

      <div id="togglePanelTab">‚Æú</div>
    </div>

    <!-- Vista principal -->
    <div id="colVista" class="col-md-8">
      <!-- Vista -->
      <div id="songView" style="display:none;">
        <h4 id="songTitle"></h4>
        <div id="songMeta" class="text-muted mb-2"></div>
        <div class="mb-3">
          <button class="btn btn-sm btn-outline-primary me-2" onclick="transpose(1)">Subir tono ‚ôØ</button>
          <button class="btn btn-sm btn-outline-secondary me-2" onclick="transpose(-1)">Bajar tono ‚ô≠</button>
          <button class="btn btn-sm btn-outline-info me-2" id="toggleColsBtn" onclick="toggleColumnas()">üß± Dos columnas</button>
          <button class="btn btn-sm btn-outline-warning" onclick="editarAlabanza()">‚úèÔ∏è Editar</button>
        </div>
        <div id="songContent" class="mb-4"></div>
      </div>

      <!-- Editor -->
      <div id="editorView" style="display:none;">
        <input type="text" id="editTitle" class="form-control mb-2" placeholder="T√≠tulo">
        <textarea id="editContent" class="form-control mb-2" rows="10" placeholder="[C]Eres fiel..."></textarea>
        <button class="btn btn-success me-2" onclick="guardarAlabanza()">üíæ Guardar</button>
        <button class="btn btn-secondary" onclick="cancelarEdicion()">Cancelar</button>
      </div>
    </div>
  </div>
  
</div>

<script>
  
  let alabanzas = JSON.parse(localStorage.getItem("alabanzas") || "[]");
  let seleccionadas = JSON.parse(localStorage.getItem("seleccionadas") || "[]");
  let alabanzaActual = null;
  let semitonoOffset = 0;

  const notas = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const bemoles = {"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#"};
  const songList = document.getElementById("songList");
  const selectedList = document.getElementById("selectedList");
  const searchInput = document.getElementById("searchInput");

  renderListas();
  searchInput.addEventListener("input", renderListas);

  // --------------------------
  // Tema (modo d√≠a/noche)
  // --------------------------
  const themeToggle = document.getElementById("themeToggle");
  const savedTheme = localStorage.getItem("theme") || "light";
  document.body.classList.add(savedTheme + "-mode");
  themeToggle.textContent = savedTheme === "light" ? "üåô Noche" : "‚òÄÔ∏è D√≠a";
  accordionList();
  themeToggle.addEventListener("click", () => {
    const current = document.body.classList.contains("dark-mode") ? "dark" : "light";
    const newTheme = current === "light" ? "dark" : "light";
    document.body.classList.remove(current + "-mode");
    document.body.classList.add(newTheme + "-mode");
    localStorage.setItem("theme", newTheme);
    themeToggle.textContent = newTheme === "light" ? "üåô Noche" : "‚òÄÔ∏è D√≠a";
    let tono=document.getElementById("songMeta");
    tono.classList.remove(current);
    tono.classList.add(newTheme);
    accordionList();
  });

  // --------------------------
  // Render de listas
  // --------------------------
  function renderListas() {
    const filtro = searchInput.value.toLowerCase();
    songList.innerHTML = "";
    selectedList.innerHTML = "";

    // Recorremos el array original para que el √≠ndice i sea el √≠ndice real en `alabanzas`
    alabanzas.forEach((a, i) => {
      if (!a.titulo || !a.titulo.toLowerCase().includes(filtro)) return;

      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `<span role="button">${a.titulo}</span>
                      <button class="btn btn-sm btn-outline-success">‚ûï</button>`;

      // usamos el √≠ndice 'i' (√≠ndice real en `alabanzas`)
      li.querySelector("span").onclick = () => mostrarAlabanza(i);
      li.querySelector("button").onclick = () => agregarSeleccionada(i);
      songList.appendChild(li);
    });

    // Seleccionadas: aqu√≠ usamos los √≠ndices de `seleccionadas` (array separado)
    seleccionadas.forEach((a, i) => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `<span role="button">${a.titulo}</span>
                      <button class="btn btn-sm btn-outline-danger">‚ûñ</button>`;
      li.querySelector("span").onclick = () => mostrarSeleccionada(i);
      li.querySelector("button").onclick = () => quitarSeleccionada(i);
      selectedList.appendChild(li);
    });

    localStorage.setItem("seleccionadas", JSON.stringify(seleccionadas));
  }

  // --------------------------
  // Selecci√≥n
  // --------------------------
  function agregarSeleccionada(i) {
    const item = alabanzas[i];
    if (!seleccionadas.find(a => a.titulo === item.titulo)) {
      seleccionadas.push(item);
      renderListas();
    }
  }

  function quitarSeleccionada(i) {
    seleccionadas.splice(i, 1);
    renderListas();
  }

  function limpiarSeleccionadas() {
    if (confirm("¬øQuitar todas las seleccionadas?")) {
      seleccionadas = [];
      renderListas();
    }
  }

  function accordionList(){
    const acc = document.getElementById('buttonCollapse');
    const contentAcc = document.getElementById('contentAcc');
    const current = document.body.classList.contains("dark-mode") ? "dark" : "light";
    const contrario = current=="dark"?"light":"dark";
    console.log(current)
    acc.classList.remove(contrario);
    acc.classList.remove("bg-"+contrario);

    acc.classList.add("bg-"+current);
    acc.classList.add(current);

    contentAcc.classList.remove(contrario);
    contentAcc.classList.remove("bg-"+contrario);

    contentAcc.classList.add("bg-"+current);
    contentAcc.classList.add(current);

  }
  // --------------------------
  // Mostrar / Render
  // --------------------------
  function mostrarAlabanza(index) {
    alabanzaActual = { tipo: "todas", index };
    semitonoOffset = 0;
    renderAlabanza(alabanzas[index].contenido);
  }

  function mostrarSeleccionada(index) {
    alabanzaActual = { tipo: "seleccionadas", index };
    semitonoOffset = 0;
    renderAlabanza(seleccionadas[index].contenido);
  }

  function renderAlabanza(contenido) {
    const titulo = (contenido.match(/{title:\s*(.+)}/i) || [])[1] || "";
    const artista = (contenido.match(/{artist:\s*(.+)}/i) || [])[1] || "";
    const tonoOriginal = (contenido.match(/{key:\s*([A-G][#b]?)/i) || [])[1] || "";
    const tonoTranspuesto = tonoOriginal ? transponerNota(tonoOriginal, semitonoOffset) : "";

    document.getElementById("songTitle").textContent = titulo;
    document.getElementById("songMeta").innerHTML = `
      ${artista ? artista + " ‚Äî " : ""} 
      ${tonoOriginal ? `<strong>Tono:</strong> ${tonoTranspuesto}` : ""}`;
    document.getElementById("songContent").innerHTML = `<div class="alabanza-texto">${formatoChordProVisual(contenido)}</div>`;
    ajustarColumnas();
    // üîΩ Restaura modo de una columna al cambiar alabanza
    const contenedor = document.querySelector('.alabanza-texto');
    const btn = document.getElementById('toggleColsBtn');
    if (contenedor && btn) {
      contenedor.classList.remove('dos-columnas');
      btn.textContent = "üß± Dos columnas";
    }
    document.getElementById("songView").style.display = "block";
    document.getElementById("editorView").style.display = "none";
  }

  function formatoChordProVisual(text) {
    function escapeHtml(s) {
      return s.replace(/&/g,"&amp;")
              .replace(/</g,"&lt;")
              .replace(/>/g,"&gt;");
    }

    const lines = text.split("\n");
    let html = "";

    for (let rawLine of lines) {
      let line = rawLine.replace(/\r/g, "").replace(/\t/g, " ");
      if (!line.trim()) { html += "<br>"; continue; }

      // Comentarios tipo {c: ...}
      if (line.match(/^{c[:}]?.*}$/i)) {
        const comentario = line.replace(/^{c[:}]?/i, "").replace("}", "").trim();
        html += `<div class="fw-bold mt-3">${escapeHtml(comentario)}</div>`;
        continue;
      }

      // Omitir metadatos como {title}, {artist}, etc.
      if (line.match(/^{(title|artist|key|sot|eot).*}$/i)) continue;

      // Si no hay acordes, mostrar texto normal
      if (!line.includes("[")) {
        html += `<pre>${escapeHtml(line)}</pre>`;
        continue;
      }

      // Procesar acordes
      const chords = [];
      const lyrics = [""];
      let i = 0;
      while (i < line.length) {
        if (line[i] === "[") {
          const j = line.indexOf("]", i);
          if (j === -1) { lyrics[lyrics.length - 1] += line.slice(i); break; }
          chords.push(line.substring(i+1, j)); // guarda acorde
          lyrics.push("");
          i = j + 1;
        } else {
          lyrics[lyrics.length - 1] += line[i];
          i++;
        }
      }

      // Construir l√≠nea de acordes alineada
      let chordLine = " ".repeat(lyrics[0].length);
      for (let k = 0; k < chords.length; k++) {
        const nextLen = Math.max((lyrics[k+1] || "").length, 1);
        chordLine += chords[k].padEnd(nextLen, " ");
      }

      const lyricText = lyrics.join("");
      html += `<pre><span class="chord-line">${escapeHtml(chordLine)}</span>\n${escapeHtml(lyricText)}</pre>`;
    }
    
    return html;
  }


  // --------------------------
  // Transposici√≥n
  // --------------------------
  function transpose(semitonos) {
    semitonoOffset += semitonos;
    const lista = alabanzaActual.tipo === "seleccionadas" ? seleccionadas : alabanzas;
    const a = lista[alabanzaActual.index];
    const transposed = a.contenido.replace(/\[([A-G][#b]?)([^/\]]*)(?:\/([A-G][#b]?))?\]/g,
      (m, root, suffix, bass) => {
        root = bemoles[root] || root;
        let i = notas.indexOf(root);
        if (i === -1) return m;
        let nuevaRoot = notas[(i + semitonoOffset + 12) % 12];
        if (bass) {
          bass = bemoles[bass] || bass;
          let j = notas.indexOf(bass);
          if (j !== -1) bass = notas[(j + semitonoOffset + 12) % 12];
          return `[${nuevaRoot}${suffix}/${bass}]`;
        }
        return `[${nuevaRoot}${suffix}]`;
      });
    renderAlabanza(transposed);
  }

  function transponerNota(nota, semitonos) {
    nota = bemoles[nota] || nota;
    let i = notas.indexOf(nota);
    if (i === -1) return nota;
    return notas[(i + semitonos + 12) % 12];
  }

  // --------------------------
  // CRUD y JSON
  // --------------------------
  function nuevaAlabanza() {
    alabanzaActual = null;
    document.getElementById("editTitle").value = "";
    document.getElementById("editContent").value = "";
    document.getElementById("editorView").style.display = "block";
    document.getElementById("songView").style.display = "none";
  }

  function editarAlabanza() {
    const lista = alabanzaActual.tipo === "seleccionadas" ? seleccionadas : alabanzas;
    const a = lista[alabanzaActual.index];
    document.getElementById("editTitle").value = a.titulo;
    document.getElementById("editContent").value = a.contenido;
    document.getElementById("editorView").style.display = "block";
    document.getElementById("songView").style.display = "none";
  }

  function guardarAlabanza() {
    const titulo = document.getElementById("editTitle").value.trim();
    const contenido = document.getElementById("editContent").value.trim();
    if (!titulo || !contenido) return alert("Debe ingresar t√≠tulo y contenido.");

    if (alabanzaActual === null)
      alabanzas.push({titulo, contenido});
    else {
      const lista = alabanzaActual.tipo === "seleccionadas" ? seleccionadas : alabanzas;
      lista[alabanzaActual.index] = {titulo, contenido};
    }

    localStorage.setItem("alabanzas", JSON.stringify(alabanzas));
    localStorage.setItem("seleccionadas", JSON.stringify(seleccionadas));
    document.getElementById("editorView").style.display = "none";
    renderListas();
    alert("‚úÖ Alabanza guardada");
  }

  function cancelarEdicion() {
    document.getElementById("editorView").style.display = "none";
  }

  function exportarJSON() {
    const blob = new Blob([JSON.stringify(alabanzas, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "alabanzas.json";
    a.click();
    URL.revokeObjectURL(url);
    alert("üì§ Archivo exportado.");
  }

  function importarJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        if (!Array.isArray(data)) throw new Error();
        alabanzas = data;
        localStorage.setItem("alabanzas", JSON.stringify(alabanzas));
        renderListas();
        alert("üì• Archivo importado correctamente.");
      } catch {
        alert("‚ùå Archivo no v√°lido.");
      }
    };
    reader.readAsText(file);
  }

  function ajustarColumnas() {
  const contenedor = document.querySelector('.alabanza-texto');
  if (!contenedor) return;

  // si el contenido es muy alto, activamos dos columnas
  const altura = contenedor.scrollHeight;
  const altoViewport = window.innerHeight;

  if (altura > altoViewport * 1.2) {
    contenedor.classList.add('dos-columnas');
  } else {
    contenedor.classList.remove('dos-columnas');
  }
}

function toggleColumnas() {
  const contenedor = document.querySelector('.alabanza-texto');
  const btn = document.getElementById('toggleColsBtn');
  if (!contenedor) return;

  contenedor.classList.toggle('dos-columnas');
  const enDosColumnas = contenedor.classList.contains('dos-columnas');
  btn.textContent = enDosColumnas ? "üß± Una columna" : "üß± Dos columnas";
}

// --------------------------
// Panel colapsable de seleccionadas
// --------------------------
const togglePanelTab = document.getElementById("togglePanelTab");
const panelSeleccionadas = document.getElementById("panelSeleccionadas");
const colVista = document.getElementById("colVista");
let panelVisible = true;

togglePanelTab.addEventListener("click", () => {
  if (panelVisible) {
    // Ocultar panel de seleccionadas
    panelSeleccionadas.style.display = "none";
    colVista.classList.add("expandido");
    togglePanelTab.textContent = "‚Æû";
    // Mueve la pesta√±a al borde izquierdo de la pantalla
    document.body.appendChild(togglePanelTab);
    togglePanelTab.style.left = "0";
    togglePanelTab.style.right = "auto";
    togglePanelTab.style.position = "fixed";
  } else {
    // Mostrar panel de seleccionadas
    panelSeleccionadas.style.display = "block";
    colVista.classList.remove("expandido");
    togglePanelTab.textContent = "‚Æú";
    // Vuelve la pesta√±a a su posici√≥n original
    panelSeleccionadas.appendChild(togglePanelTab);
    togglePanelTab.style.position = "absolute";
    togglePanelTab.style.left = "auto";
    togglePanelTab.style.right = "-15px";
  }
  panelVisible = !panelVisible;
});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>
</html>
